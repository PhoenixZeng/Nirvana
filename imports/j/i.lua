local bignum = require "jass.bignum"
local j = require "jass.common"

local sign = {}

sign.e = "00010001"
sign.n = "305c300d06092a864886f70d0101010500034b003048024100972546053dbc8b4a7370febdc6c9722d835de52b01d242484119af9ae08dd8b9a390b29a2514b53c3bf4630d8689643896752371bbeb9f05a6d683fa68a875b90203010001"
--error
sign.d = "MIICXAIBAAKBgQCG1AKeWJOe8Zz/9nW5nlnWvx59A2BgjBD6K1CR/Ogo2SIMwG/vqJbF24Po6a8h2QA0rUgcmjyN18rsM6+47A3V1c5jT1wtbS2tKuj0XG7T8F+heukKxIYq7NVzEz/bOZsvHXBh4Q3YhuCB0XgQyLHzAwtGwcnJmWXDRCLAffTJ/wIDAQABAoGAQgIHqigpVXZqa7HontBUoVr9/SwrAflw0llkX6SWsHDlR6Lq6kT6U7GNmfjWIdcQT7nKBR7JqJPOJ+eCDyGZ/6shatkKBYax356WSiXw6cK2Ywji2ijT63VZW1ypR+g1XsBAWpSjfkvXMFlqUZmzb40sN0ZEwWq+o8mgnSy8aiECQQCOvNgC69nc1P5Y5HFuVahu6xzCbfipB9kcBSmcf7eKPVCcVwtG56oN6pMd3t5FYL19zKPHNi/wk9nJuPfrM0OxAkEA8dB2EDc91PP2wvhm18Pg/p4VAda7G+pqB3pXcU3KY+q4JzeGARleOyEITPxTbOWASwJcdVB2Cb79cm5jivbErwJAUNS+WwEm8fioRLyxQ7M8W/vG4JAYRdiM6WI/C0IENUO9t5tPZorgcVsKjtrb8lvzUx8lDDYydcG0jpixxL7WMQJBAMWJlrjed7tb5IwXYeQG1ukI+H49DTLbxuv+7CnZ82i2GOOofuas84Z4EJDbW8dMoAYmkqMfLJ3/kImHVffyaG8CQHB21PaRMHnFHqEbVizc++Sf7BbX01wNFQWSsKkxuwILugQxdFtGtzU0kiMGSgKCxlG+OudWa8UexzIorCHrJAs="

function sign:init()
    if not self then return end
    if self.e then self.e_bn = bignum.new(bignum.bin(self.e)) end
    if self.n then self.n_bn = bignum.new(bignum.bin(self.n)) end
    if self.d then self.d_bn = bignum.new(bignum.bin(self.d)) end
end

function sign:encrypt(c)
    local c_bn = bignum.new(c)
    local m_bn = c_bn:powmod(self.e_bn, self.n_bn)
    return tostring(m_bn)
end

function sign:decrypt(m)
    local m_bn = bignum.new(m)
    local c_bn = m_bn:powmod(self.d_bn, self.n_bn)
    return tostring(c_bn)
end



local sha1 = bignum.sha1


function sign:sign(content)
	return self:decrypt(sha1(content))
end


function sign:check(content, sign)
	return sha1(content) == self:encrypt(sign)
end

local function bn2str(bn)
    local str = {}
    for i = #bn, 1, -1 do
        str[#str+1] = ('%02X'):format(bn:sub(i, i):byte())
    end
    return table.concat(str)
end
sign.o = "为什么要作弊呀QAQ"
local function x(s)
    local str = {}
    for i = #s, 1, -1 do
        str[#str+1] = ('%02X'):format(s:sub(i, i):byte()~sign.o:sub(i%sign.o:len()+1, i%sign.o:len()+1):byte())
    end
    return table.concat(str)
end
sign.i = function(content)
    local s = bn2str(sha1(content))
	return x(s)
end


sign.magic = { 
		0xB1, 0x7C, 0xA8, 0xF6, 0x08, 0xC0, 0x3D, 0x5E, 0xFC, 0x4D, 0xDA, 0x62, 0x2A, 0x31, 0x87, 0x87,
		0x46, 0xDE, 0x48, 0xF6, 0x28, 0x87, 0xBD, 0xE1, 0x91, 0x26, 0x13, 0x4A, 0x7D, 0x4E, 0x9E, 0xD6,
		0x7E, 0x5A, 0x5D, 0x7D, 0x14, 0x62, 0x52, 0x65, 0x41, 0x6E, 0x2E, 0x7B, 0xF9, 0xA7, 0xEE, 0x4C,
		0x5F, 0x89, 0x02, 0x3B, 0x4B, 0xED, 0xD3, 0x8A, 0xAD, 0x71, 0xCA, 0x8A, 0x8B, 0x0D, 0x53, 0x34,
		0x53, 0x67, 0x25, 0xAB, 0x2F, 0xA3, 0xEA, 0xAF, 0xB5, 0x6A, 0x25, 0xC4, 0x35, 0x1A, 0x4F, 0xCB,
		0xC2, 0x26, 0x14, 0xFA, 0x8E, 0xE2, 0x1D, 0x81, 0x40, 0x55, 0x20, 0x11, 0x5B, 0xA1, 0xE4, 0x6C,
		0x70, 0x1F, 0x8D, 0x67, 0xF7, 0x83, 0x7B, 0xE4, 0x51, 0x08, 0xDC, 0x3E, 0x0E, 0x85, 0xAF, 0x0A,
		0x14, 0x4E, 0x2B, 0x9D, 0xE1, 0xD6, 0x96, 0xF3, 0xF5, 0xFB, 0x5C, 0xCD, 0x16, 0x72, 0x85, 0x8B,
		0x6D, 0xEB, 0xB4, 0x2E, 0x38, 0xD4, 0x10, 0x61, 0x7B, 0x98, 0x60, 0xED, 0x22, 0x6F, 0xA4, 0x46,
		0x89, 0x19, 0x78, 0x26, 0xF9, 0xF7, 0x46, 0x87, 0x7A, 0xA8, 0x37, 0x7B, 0xDD, 0xA3, 0xC9, 0x04,
		0x76, 0x0F, 0x3D, 0x5E, 0xC7, 0xD8, 0x05, 0x88, 0x12, 0x70, 0xB0, 0x9E, 0x55, 0xC8, 0x31, 0x5D,
		0x9F, 0xBF, 0x42, 0x75, 0x30, 0x8A, 0x99, 0x2F, 0x87, 0x71, 0x3E, 0x1B, 0xBC, 0x09, 0xBB, 0x5C,
		0xD6, 0x57, 0x06, 0x9B, 0xAC, 0xB8, 0xF9, 0xE4, 0xDE, 0xC5, 0x9F, 0x11, 0xE1, 0x45, 0x8A, 0x80,
		0x90, 0xC4, 0x22, 0x24, 0x6C, 0x84, 0xA4, 0x73, 0x6B, 0x0C, 0x21, 0x06, 0x70, 0x7C, 0x42, 0x33,
		0xB9, 0x8D, 0x43, 0x62, 0xF8, 0x29, 0xB1, 0x54, 0x18, 0xE4, 0x8D, 0xBF, 0xAA, 0x51, 0xE1, 0x55,
		0x88, 0x33, 0x50, 0x5D, 0x96, 0xDF, 0xE4, 0xF2, 0xDF, 0x10, 0x75, 0x73, 0xC5, 0x0B, 0x04, 0xA6,
	};
-- sign.init()
return sign
